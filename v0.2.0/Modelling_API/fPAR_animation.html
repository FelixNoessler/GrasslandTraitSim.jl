<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Animation: fPAR</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lato&display=swap');
        body, text {
            font-size: 14px;
            font-family: "Lato", sans-serif;
            font-weight: 400;
            font-style: normal;
        }
        tr.spaceUnder>td { padding-bottom: 0.7em;}
    </style>
</head>
<body>
    <table>
        <col width="200px">
        <col width="50px">
        <tr class="spaceUnder">
            <td>extinction coefficient (k)</td>
            <td><span id="k-value">0.6</span></td>
            <td><input type="range" min="0.3" max="1.0" step="0.1" value="0.6" id="k"></td>
        </tr>
        <tr class="spaceUnder">
            <td>effect of community height on shading  (α_comH)</td>
            <td><span id="α_comH-value">0.75</span></td>
            <td><input type="range" min="0.0" max="1" step="0.05" value="0.75" id="α_comH" class="slider"></td>
        </tr>
        <tr>
            <td>community weighted mean height (H_cwm)</td>
            <td><span id="H_cwm-value">0.7</span></td>
            <td><input type="range" min="0.05" max="2.0" step="0.05" value="0.7" id="H_cwm"></td>
        </tr>
    </table>
    
    <!-- Legend -->
    <div class="legend" style="margin-top: 10px;">
        <svg width="500" height="37">
            <g>
                <rect x="10" y="0" width="15" height="15" style="fill: steelblue;"></rect>
                <text x="30" y="12" class="legend-text">excluding the effect of community height</text>
                <rect x="10" y="20" width="15" height="15" style="fill: red;"></rect>
                <text x="30" y="32" class="legend-text">with the influence of the community height</text>
            </g>
        </svg>
    </div>
    
    <svg width="500" height="400" id="svg_graph"></svg>

    <script>

        const svg = d3.select("#svg_graph"),
              margin = {top: 20, right: 30, bottom: 45, left: 50},
              width = +svg.attr("width") - margin.left - margin.right,
              height = +svg.attr("height") - margin.top - margin.bottom,
              g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

        const max_LAItot = 10;
        const x = d3.scaleLinear().range([0, width]).domain([0, max_LAItot]); 
        const y = d3.scaleLinear().range([height, 0]).domain([0, 1]); 
        
        // Create axes
        g.append("g")
            .attr("class", "x-axis")
            .attr("transform", `translate(0, ${height})`)
            .call(d3.axisBottom(x));

        g.append("g")
            .attr("class", "y-axis")
            .call(d3.axisLeft(y));

        // Axes labels
        g.append("text")
            .attr("class", "x-label")
            .attr("x", width / 2)
            .attr("y", height + 40)
            .attr("text-anchor", "middle")
            .text("Leaf area index of community (LAItot) [-]");

        g.append("text")
            .attr("class", "y-label")
            .attr("x", -height / 2)
            .attr("y", -40)
            .attr("transform", "rotate(-90)")
            .attr("text-anchor", "middle")
            .text("Fraction of radiation intercepted (fPAR) [-]");
        
        function calcShading(){
            return Math.exp(Math.log(α_comH)*0.2 / H_cwm)
        }
        
        function calcInterception(LAItot){
            return (1 - Math.exp(-k * LAItot))
        }
        
        function calcData(height_influence = false) {
            const data = [];
            for (let LAItot = 0; LAItot <= max_LAItot; LAItot += 0.1) {
                if (height_influence) {
                    data.push({ LAItot, fPAR: calcInterception(LAItot) * calcShading()});
                }else {
                    data.push({ LAItot, fPAR: calcInterception(LAItot) });
                } 
            }
            return data
        }
        
        const line = d3.line()
            .x(d => x(d.LAItot))
            .y(d => y(d.fPAR));
            
        const line1 = d3.line()
            .x(d => x(d.LAItot))
            .y(d => y(d.fPAR));

        let k = 0.6, α_comH = 0.75, H_cwm = 0.7;
        
        let data1 = calcData();
        let data2 = calcData(height_influence = true);

        const path = g.append("path")
            .datum(data1)
            .attr("class", "line")
            .attr("fill", "none")
            .attr("stroke", "steelblue")
            .attr("stroke-width", 2)
            .attr("d", line);
        
        const path1 = g.append("path")
            .datum(data2)
            .attr("class", "line")
            .attr("fill", "none")
            .attr("stroke", "red")
            .attr("stroke-width", 2)
            .attr("d", line1);

        // Update function
        function updatePlot() {
            k = +d3.select("#k").property("value");
            α_comH = +d3.select("#α_comH").property("value");
            H_cwm = +d3.select("#H_cwm").property("value");

            // Update slider labels
            d3.select("#k-value").text(k);
            d3.select("#α_comH-value").text(α_comH);
            d3.select("#H_cwm-value").text(H_cwm);

            // Recalculate data
            data1 = calcData();
            data2 = calcData(height_influence = true);

            // Update line
            path.datum(data1)
                .transition()
                .duration(500)
                .attr("d", line);
                
            path1.datum(data2)
                .transition()
                .duration(500)
                .attr("d", line1);
        }

        // Event listeners for sliders
        d3.select("#k").on("input", updatePlot);
        d3.select("#α_comH").on("input", updatePlot);
        d3.select("#H_cwm").on("input", updatePlot);
        
        updatePlot();
    </script>
  
</body>
</html>
