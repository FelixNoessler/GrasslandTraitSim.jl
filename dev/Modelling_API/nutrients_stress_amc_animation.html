<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMC Nutrient Stress Visualization</title>
    
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lato&display=swap');
        body, text {
            font-size: 14px;
            font-family: "Lato", sans-serif;
            font-weight: 400;
            font-style: normal;
        }
        tr.spaceUnder>td { padding-bottom: 0.7em;}
    </style>
    
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://unpkg.com/d3-scale-chromatic@2.0.0/dist/d3-scale-chromatic.min.js"></script>
</head>
<body>
    <table>
        <col width="300px">
        <col width="30px">
        <tr class="spaceUnder">
            <td>mean response at \(NUT = 0.5\) \(\;\alpha_{namc,05}\;\)<br>see red dot (strong to weak growth reduction)</td>
            <td><span id="R_wrsa_04_ϕ-value">0.9</span></td>
            <td><input type="range" id="R_wrsa_04_ϕ" min="0.1" max="0.99" step="0.01" value="0.9"></td>
        </tr>
        <tr class="spaceUnder">
            <td>difference between species \(\;\delta_{namc}\;\) <br>(no to strong difference)</td>
            <td><span id="β_wrsa_red04-value">10</span></td>
            <td><input type="range" id="β_wrsa_red04" min="0.1" max="15.0" step="0.1" value="10"></td>
        </tr>
        <tr>
            <td>slope of response  \(\beta_{namc}\)</td>
            <td><span id="β_wrsa-value">7</span></td>
            <td><input type="range" id="β_wrsa" min="5" max="15" step="0.1" value="7"></td>
        </tr>
    </table>

    <svg width="750" height="600"></svg>

    <script>
        // Set up SVG dimensions
        const margin = { top: 20, right: 60, bottom: 50, left: 70 },
            width = 600 - margin.left - margin.right,
            height = 400 - margin.top - margin.bottom;

        const svg = d3.select("svg")
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        const x = d3.scaleLinear().domain([0, 1]).range([0, width]);
        const y = d3.scaleLinear().domain([0, 1]).range([height, 0]);
        const color = d3.scaleSequential(d3.interpolateViridis).domain([0.0, 0.4]);

        const xAxis = d3.axisBottom(x);
        const yAxis = d3.axisLeft(y);

        svg.append("g")
            .attr("transform", `translate(0,${height})`)
            .call(xAxis)
            .append("text")
            .attr("class", "axis-label")
            .attr("x", width / 2)
            .attr("y", 40)
            .attr("fill", "#000")
            .text("Plant available nutrients (N_p) [-]");

        svg.append("g")
            .call(yAxis)
            .append("text")
            .attr("class", "axis-label")
            .attr("transform", "rotate(-90)")
            .attr("x", -height / 2)
            .attr("y", -40)
            .attr("fill", "#000")
            .attr("text-anchor", "middle")
            .text("Nutrient growth reducer based on AMC (N_amc) [-]");

        const line = d3.line()
            .x(d => x(d.Wsc))
            .y(d => y(d.Waterred));

        // Initial parameters
        let β_wrsa = 7, β_wrsa_red04 = 10, ϕ_rsa = 0.2, R_wrsa_04_ϕ = 0.9;
        const rsa_values = [0.0, 0.10, 0.2, 0.30, 0.4];

        // Update parameters and plot
        function updateParameters() {
            β_wrsa = +d3.select("#β_wrsa").property("value");
            β_wrsa_red04 = +d3.select("#β_wrsa_red04").property("value");
            R_wrsa_04_ϕ = +d3.select("#R_wrsa_04_ϕ").property("value");

            d3.select("#β_wrsa-value").text(β_wrsa);
            d3.select("#β_wrsa_red04-value").text(β_wrsa_red04);
            d3.select("#R_wrsa_04_ϕ-value").text(R_wrsa_04_ϕ);

            plot();
        }

        function calculateWaterred(Wsc, rsa) {
            const x0_reduction_at_04 = ϕ_rsa + 1 / β_wrsa_red04 * Math.log((1 - R_wrsa_04_ϕ) / R_wrsa_04_ϕ);
            const R_wrsa_04 = 1 / (1 + Math.exp(-β_wrsa_red04 * (rsa - x0_reduction_at_04)));
            const x0_wrsa = Math.log(1 / R_wrsa_04 - 1) / β_wrsa + 0.5;
            return 1 / (1 + Math.exp(-β_wrsa * (Wsc - x0_wrsa)));
        }

        function plot() {
            svg.selectAll(".line").remove();
            svg.selectAll(".dot").remove();
            
            rsa_values.forEach(rsa => {
                const data = [];
                for (let Wsc = 0; Wsc <= 1; Wsc += 0.01) {
                    data.push({ Wsc, Waterred: calculateWaterred(Wsc, rsa) });
                }

                svg.append("path")
                    .datum(data)
                    .attr("class", "line")
                    .attr("fill", "none")
                    .attr("stroke", color(rsa))
                    .attr("stroke-width", 1.5)
                    .attr("d", line);
            });
            
            svg.append("circle")
                .attr("class", "dot")
                .attr("cx", x(0.5))
                .attr("cy", y(R_wrsa_04_ϕ))
                .attr("r", 3)
                .attr("fill", "red");
        }

        function updateColorbar() {
            const colorbarHeight = 300;
            const colorbarWidth = 20;
            const colorScale = d3.scaleLinear()
                .domain([0, colorbarHeight])
                .range([0.0, 0.4]);

            if (svg.selectAll(".colorbar").empty()) {
                const defs = svg.append("defs");

                const linearGradient = defs.append("linearGradient")
                    .attr("id", "linear-gradient")
                    .attr("x1", "0%")
                    .attr("y1", "100%")
                    .attr("x2", "0%")
                    .attr("y2", "0%");

                for (let i = 0; i <= colorbarHeight; i++) {
                    linearGradient.append("stop")
                        .attr("offset", `${(i / colorbarHeight) * 100}%`)
                        .attr("stop-color", color(colorScale(i)));
                }

                svg.append("rect")
                    .attr("x", width + 10)
                    .attr("y", (height - colorbarHeight) / 2)
                    .attr("width", colorbarWidth)
                    .attr("height", colorbarHeight)
                    .style("fill", "url(#linear-gradient)")
                    .attr("class", "colorbar");

                const colorbarScale = d3.scaleLinear()
                    .domain([0.0, 0.4])
                    .range([(height - colorbarHeight) / 2 + colorbarHeight, (height - colorbarHeight) / 2]);

                const colorbarAxis = d3.axisRight(colorbarScale)
                    .ticks(5)
                    .tickFormat(d3.format(".3f"));

                svg.append("g")
                    .attr("transform", `translate(${width + 10 + colorbarWidth}, 0)`)
                    .attr("class", "colorbar-axis")
                    .call(colorbarAxis);
                    
                const textData = ["Arbuscular mycorrhizal", "colonisation per total biomass [m² g⁻¹]"];
                const centerX = width + 10 + colorbarWidth + 60;
                const centerY = (height - colorbarHeight) / 2 + colorbarHeight / 2;    
                svg.append("text")   
                    .attr("x", centerX)
                    .attr("y", centerY) 
                    .attr("text-anchor", "middle")
                    .attr("font-size", "16px")
                    .attr("transform", `rotate(90, ${centerX}, ${centerY})`)  // Rotate around the center
                    .selectAll("tspan")
                    .data(textData)
                    .enter()
                    .append("tspan")
                    .attr("x", centerX)
                    .attr("dy", (d, i) => i * 25 - ((textData.length - 1) * 10))  // Adjust dy to center the lines
                    .text(d => d);
            }
        }

        updateColorbar();
        plot();

        // Event listeners for sliders
        d3.selectAll("input").on("input", updateParameters);
    </script>
</body>
</html>
